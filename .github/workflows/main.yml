on:
  push:
    branches:
      - main
      - develop

name: "üê¶ Build Flutter to Firebase Distribution"

jobs:
  flutter_test:
    name: üí™üèª Run flutter test and analyze
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/master' ||
      github.ref == 'refs/heads/uat' ||
      github.ref == 'refs/heads/develop' ||
      startsWith(github.event.head_commit.message, '[BUILD')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Checkout submodules
        run: git submodule update --init --recursive
      - name: üõ† Setup Java 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: "2.8.1"
          channel: "stable"
      - name: ‚åõÔ∏è Run flutter pub get...
        run: flutter pub get
      - name: üîé Run flutter analyze... (Treat Warning only)
        run: flutter analyze --no-fatal-infos
      - name: ‚åõÔ∏è Run flutter test...
        run: flutter test
  
  build_android:
    name: ü§ñ Build Android application...
    needs: [flutter_test]
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/develop' ||
      startsWith(github.event.head_commit.message, '[BUILD]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Checkout submodules
        run: git submodule update --init --recursive
      - name: üîë Decode Keystore (debug)
        if: |
          github.ref == 'refs/heads/develop' ||
          startsWith(github.event.head_commit.message, '[BUILD')
        id: decode_keystore_debug
        uses: timheuer/base64-to-file@v1
        with:
          fileName: 'keystore/debug.keystore'
          encodedString: ${{ secrets.ENCODED_KEYSTORE_DEBUG }}
      # - name: üîë Decode Keystore (release)
      #   if: |
      #     github.ref == 'refs/heads/develop' ||
      #     startsWith(github.event.head_commit.message, '[BUILD PROD')
      #   id: decode_keystore_release
      #   uses: timheuer/base64-to-file@v1
      #   with:
      #     fileName: 'keystore/uploadkey.jks'
      #     encodedString: ${{ secrets.ENCODED_KEYSTORE_RELEASE }}

      - name: ü§ê Add env.dev
        if : |
          github.ref == 'refs/heads/develop' ||
          startsWith(github.event.head_commit.message, '[BUILD DEV')
        env: 
          ENV_DEV : ${{ secrets.ENV_DEV }}
        run: echo $ENV_DEV > .env.dev

      - name: ü§ê Add env.prod
        if : |
            github.ref == 'refs/heads/develop' ||
            startsWith(github.event.head_commit.message, '[BUILD PROD')
        env: 
          ENV_PROD : ${{ secrets.ENV_PROD }}
        run: echo $ENV_PROD > .env.prod

      - name: üî• Decode Firebase Service
        env:
          FIREBASE_CONFIG: ${{ secrets.GOOGLE_SERVICES }}
        run: echo $FIREBASE_CONFIG > android/app/google-services.json

      - name: üõ† Setup Java 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: "2.x"
          channel: "stable"
      - run: flutter pub get
      - run: flutter clean

      - name: üöÄ Build application (dev:debug)...
        if: |
          github.ref == 'refs/heads/develop' ||
          startsWith(github.event.head_commit.message, '[BUILD DEV')
        env:
          SIGNING_KEY_ALIAS_DEBUG: ${{ secrets.KEY_ALIAS_DEBUG }}
          SIGNING_PASSWORD_DEBUG: ${{ secrets.KEY_PASS_DEBUG }}
        #- run: flutter build appbundle
        run: flutter build apk --flavor dev --debug

      - name: üöÄ Build application (prod:debug)...
        if: |
          github.ref == 'refs/heads/develop' ||
          startsWith(github.event.head_commit.message, '[BUILD PROD')
        env:
          SIGNING_KEY_ALIAS_DEBUG: ${{ secrets.KEY_ALIAS_DEBUG }}
          SIGNING_PASSWORD_DEBUG: ${{ secrets.KEY_PASS_DEBUG }}
        # env:
        #   SIGNING_KEY_ALIAS_RELEASE: ${{ secrets.KEY_ALIAS_RELEASE }}
        #   SIGNING_PASSWORD_RELEASE: ${{ secrets.KEY_PASS_RELEASE }}
        #- run: flutter build appbundle
        run: flutter build apk --flavor prod --debug

      - name: ‚òÅÔ∏è Upload .apk to Firebase App Distribution prod...
        if : |
          github.ref == 'refs/heades/develop' ||
          startsWith(github.event.head_commit.message, '[BUILD PROD')
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{secrets.FIREBASE_DISTRIBUTE_APP_ID_DEV}}
          token: ${{secrets.FIREBASE_CLI_TOKEN}}
          file: build/app/outputs/apk/prod/debug/app-prod-debug.apk
        
      - name: ‚òÅÔ∏è Upload .apk to Firebase App Distribution dev...
        if : |
          github.ref == 'refs/heades/develop' ||
          startsWith(github.event.head_commit.message, '[BUILD DEV')
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{secrets.FIREBASE_DISTRIBUTE_APP_ID_DEV}}
          token: ${{secrets.FIREBASE_CLI_TOKEN}}
          file: build/app/outputs/apk/dev/debug/app-dev-debug.apk

      - name: Notify slack success
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: voxmedia/github-action-slack-notify-build@v1
        with:
          channel: poc-flutter-nut-bot-ci
          status: ‚úÖ  SUCCESS DEPLOY 
          color: good

